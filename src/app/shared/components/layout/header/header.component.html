<!-- header.component.html -->
<mat-toolbar
  class="bg-white shadow flex justify-between items-center sticky top-0 z-10 px-4 md:px-6 py-3"
>
  <!-- LOGO -->
  <strong
    class="cursor-pointer text-2xl md:text-4xl text-indigo-600"
    style="font-family: 'Orbitron', sans-serif;"
    (click)="goHome()"
  >
    SmartShop
  </strong>

  <!-- MENU PRINCIPAL -->
  <div class="hidden lg:flex space-x-4 ml-6">
    <button mat-button (click)="goToProducts()" class="text-gray-800 hover:text-indigo-600">
      Products
    </button>
    <button mat-button (click)="goToRatings()" class="text-gray-800 hover:text-indigo-600">
      Ratings
    </button>
  </div>

  <!-- SEARCH BAR -->
  <div class="flex-1 mx-6 hidden md:flex justify-center">
    <div class="relative w-full max-w-md">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="Rechercher..."
        class="h-10 w-full pl-4 pr-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
        (input)="onSearch()"
      />
      <mat-icon
        class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-600 cursor-pointer hover:text-gray-800"
        (click)="onSearch()"
        >search</mat-icon
      >

      <!-- Dropdown résultats -->
      <div
        *ngIf="searchResults.length"
        class="absolute bg-white shadow-lg rounded mt-1 w-full z-20 max-h-64 overflow-auto"
      >
        <div
          *ngFor="let product of searchResults"
          class="flex items-center gap-3 px-3 py-2 text-[0.875rem] hover:bg-gray-100 cursor-pointer"
          (click)="goToProduct(product.id)"
        >
          <img
            *ngIf="product.image_url; else noImage"
            [src]="product.image_url"
            alt="{{ product.name }}"
            class="w-10 h-10 object-cover rounded"
          />
          <ng-template #noImage>
            <div class="w-10 h-10 flex items-center justify-center bg-gray-200 text-gray-400 text-xs rounded">
              No Img
            </div>
          </ng-template>
          <div class="flex-1">
            <p class="font-medium text-gray-800 truncate">{{ product.name }}</p>
            <p class="text-gray-500 text-xs">{{ product.price | currency: 'EUR' }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ICONS DROITE -->
  <div class="flex items-center space-x-3">
    <!-- Wishlist -->
    <button
      mat-icon-button
      (click)="goToWishlist()"
      class="text-gray-800 hidden md:flex"
      [matBadge]="(wishlistCount$ | async) || '0'"
      matBadgeColor="warn"
    >
      <mat-icon>favorite_border</mat-icon>
    </button>

    <!-- Cart -->
    <div class="relative" (mouseenter)="showCartPreview = true" (mouseleave)="showCartPreview = false">
      <button mat-icon-button (click)="goToCart()">
        <mat-icon [matBadge]="(cartCount$ | async) || '0'" matBadgeColor="warn">shopping_cart</mat-icon>
      </button>

      <!-- Cart preview modal -->
      <div
        *ngIf="showCartPreview"
        class="absolute right-0 mt-2 w-80 bg-white shadow-xl border border-gray-200 rounded-lg z-50"
      >
        <ng-container *ngIf="cartItems$ | async as cartItems">
          <ng-container *ngIf="cartItems.length > 0; else emptyCart">
            <div class="p-4 max-h-96 overflow-auto space-y-3">
              <div
                *ngFor="let item of cartItems"
                class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded transition-colors"
              >
                <img
                  [src]="item.imageUrl"
                  alt="{{ item.name }}"
                  class="w-14 h-14 object-cover rounded-md border border-gray-100"
                />
                <div class="flex-1 flex flex-col">
                  <p class="text-gray-800 font-semibold truncate">{{ item.name }}</p>
                  <p class="text-gray-500 text-sm">{{ item.quantity }} x {{ item.price | currency: 'EUR' }}</p>
                </div>
                <button
                  (click)="remove(item.id)"
                  class="text-red-500 hover:text-red-700 font-bold text-xl"
                  aria-label="Remove item"
                >
                  &times;
                </button>
              </div>
            </div>

            <div class="border-t border-gray-200 p-4 flex justify-between items-center bg-gray-50">
              <span class="font-medium text-gray-700">Total:</span>
              <span class="font-bold text-gray-900">{{ cartTotal$ | async | currency: 'EUR' }}</span>
            </div>

            <div class="p-4 flex justify-between">
              <button
                class="flex-1 mr-2 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded font-medium transition"
                (click)="goToCart()"
              >
                View Cart
              </button>
              <button
                class="flex-1 ml-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium transition"
                (click)="checkout()"
              >
                Checkout
              </button>
            </div>
          </ng-container>
          <ng-template #emptyCart>
            <div class="p-6 text-center text-gray-500">Votre panier est vide</div>
          </ng-template>
        </ng-container>
      </div>
    </div>

    <!-- User / Login -->
    <ng-container *ngIf="isLoggedIn$ | async; else loginBtn">
      <button mat-icon-button [matMenuTriggerFor]="userMenu" class="text-gray-800">
        <mat-icon>account_circle</mat-icon>
      </button>
      <mat-menu #userMenu="matMenu">
        <button mat-menu-item (click)="goToProfile()">Profil</button>
        <button mat-menu-item (click)="goToMyOrders()">Mes commandes</button>
        <button mat-menu-item (click)="onLogout()">Déconnexion</button>
      </mat-menu>
    </ng-container>
    <ng-template #loginBtn>
      <button mat-icon-button (click)="onLogin()" class="text-gray-800 hidden md:flex">
        <mat-icon>login</mat-icon>
      </button>
    </ng-template>
  </div>
</mat-toolbar>
